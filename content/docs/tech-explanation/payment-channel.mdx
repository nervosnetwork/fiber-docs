---
title: What is Payment Channel Network
description: "Understanding Payment Channel Network - A Quick Walkthrough Guide"
author: Yunwen Liu
authorUrl: https://scholar.google.be/citations?user=fbnd6LMAAAAJ&hl=en
---

Layer 2 is a popular solution to the blockchain scalability problem, which, unlike implementing alternative consensus schemes and side chains, avoids the risk of forking the blockchain. A main approach in layer 2 is to open off-chain channels where two parties communicate for transactions and smart contracts outside of the underlying layer 1 blockchain. The most prominent examples of payment channels include the [lightning network](https://lightning.network/#intro) on Bitcoin and [Raiden](https://raiden.network/) on Ethereum.

Payment channels can be *unidirectional* or *bidirectional*, depending on the flow direction of the payments. In unidirectional channels, the payment is only from one party to another, not the other way around. It works like a top-up card, where you deposit some money off-chain, and transfer a certain amount within the fund limit to the receiver with your signature. When closing the channel, or the channel going depletion, the final balance information is updated on-chain hence completes the payments. In bidirectional channels, both party make a deposit to the channel at opening (this procedure is called *funding*). The problem for directly using a unidirectional channel is that, every transaction between the parties is authenticated, therefore a malicious party is able to claim previous transactions where the balance is in favor of oneself. The lightning network solved this problem by preventing any user to redeem older states, i.e., when a new transaction is signed in a bidirectional channel, the players reveal a secret information to the previous transaction for revocation.

Off-chain bidirectional payment channels with a multi-hop protocol form a payment channel network (PCN) to handle off-chain payments between two players who have no direct channel themselves. If Alice wants to send coins through an intermediary Ingrid, a crucial difficulty is the lack of trust between Alice and Ingrid. Ingrid receives a fee for doing the favor, but she worries that Alice might refuse to pay after she pays Bob. Similarly, Alice couldn't simply give the money to Ingrid and pray that Ingrid would not take the money and disappear. This is why *Hash Time Lock Contract* (HTLC) was invented. In an HTLC between Alice and Ingrid, there are two locks, a *time lock* and a *hash lock*. Ingrid gets the coins if she can solve the hash lock puzzle, which requires the pre-image of a predefined hash digest (chosen by the receiver Bob) before timeout; while Alice gets the coins in the contract after the end of the time lock if Ingrid fails to provide a correct pre-image in time.

In payment channel network protocols with HTLC-like schemes, the collateral that the parties have to pay as a cost is often defined as the product of the deposited fund and the total time. Therefore, a considerable amount of assets are locked in the channels, which poses a non-negligible negative influence on the liquidity. For instance, 30 percent of the lightning network locks approximately 890BTC of collateral with a value of 39M USD (value estimated by the time [the paper](https://eprint.iacr.org/2021/1445) on sleepy channels was written). In addition, the network topology of a payment channel network is mostly hidden for protecting the anonymous relationship and balance privacy of the players. So routing in PCN, that is to find a payment path with minimal fees and optimized efficiency, is challenging in general.

To mitigate the routing problem, payment channel hub (PCH) is a promising alternative. In a PCH, a trusted *tumbler* plays a centralized role to forward the payments from a sender to a receiver. One of the first PCH schemes was proposed by [Heilman et al.](https://www.ndss-symposium.org/ndss2017/ndss-2017-programme/tumblebit-untrusted-bitcoin-compatible-anonymous-payment-hub/) at NDSS 17, which is unidirectional, unlinkable, privacy-enhanced and Bitcoin-compatible. Here, the trust between Alice and the tumbler is a reversed version of the HTLC, in which the sender Alice needs to solve a hash puzzle to prove that she has paid the tumbler. [Perun](https://ieeexplore.ieee.org/document/8835315) proposed by Dziembowski et al. at S&P19 presented a PCH scheme for constructing virtual channels. Perun is implemented on Ethereum with Turing-complete smart contracts. A more recent PCH protocol is [A2L](https://ieeexplore.ieee.org/abstract/document/9519431) designed by Tairi et al. at S&P21. A2L gives the first PCH construction that requires minimal properties of the blockchain with only digital signatures and time-locks.

PCN players are expected to monitor the channel state regularly and frequently to detect frauds in time. However, in practice, this might bring a unbearable cost for the players, and fund lose is likely to happen if the frauds are overlooked accidentally. Especially, when an intermediary in a payment path goes offline for a long time, it greatly decreases the efficiency and success rate of the transactions. One solution is to hire watchtowers to supervise the channels for players when they are offline, and resolve possible disputes with the snapshots stored by the watchtowers. We will talk more about watchtowers later. Another approach is to build virtual channels based on payment channels. Virtual channels are off-chain channels that allow players with no direct payment channel to communicate off-chain without an intermediary. Only the open and closure of virtual channels require the participation of an intermediary node, . Perun presented such virtual channels with smart contracts. Later at S&P21, a bitcoin-compatible virtual channel scheme was proposed by [Aumayr et al.](https://ieeexplore.ieee.org/document/9519487) to remove the dependency on smart contracts. An interesting question here is whether it is possible to build virtual channels based on virtual channels.

A generalization of payment channels is studied to deploy off-chain smart contracts, those are called *state channels* or *generalized channels*, e.g., the general state channel networks presented at CCS18 by [Dziembowski et al.](https://dl.acm.org/doi/10.1145/3243734.3243856). State channels can be extended in a virtual multi-party setting as studied by  Dziembowski et al. in [this Eurocrypt19 paper](https://link.springer.com/chapter/10.1007/978-3-030-17653-2_21). [Hydra](https://eprint.iacr.org/2020/299), proposed by Chakravarty et al. at FC21 takes advantage of the extended UTxO model to reuse the on-chain smart contract system. The studies on state channels and virtual channels are fewer comparing with those on lightning networks and PCN protocols.

In the following, we will discuss on several highlighted topics in the research of payment channel networks.

## Hash Time Lock Contracts

HTLC is a vital component in the implementation of lightning network and cross-chain atomic swap protocols. The core idea is that the players deposit a certain amount of collaterals in the channel and claims the money under conditions in order to prevent frauds. However, HTLC has vulnerabilities that jeopardize the security and privacy of the network under a malicious exploration. In this section, we will talk about the security issues including bribery attacks, DoS and congestion attacks. Then we discuss the improvements on HTLC for multi-hop multi-party use cases.

### **Bribery Attack**

Bribery attack is a common threat to blockchain users by encouraging dishonest strategies with malicious incentives. In the honest case, when Alice sends coins to Bob through Ingrid, we have two HTLCs for Alice with Ingrid, and, Ingrid with Bob. When claiming the money, Ingrid receives the pre-image of the hash lock from Bob before the expiration of the second contract, then Ingrid gets redeemed from Alice by forwarding the correct pre-image to her before timeout. To include a transaction on-chain, transaction fees are paid to miners so they pack the transactions and mine a block. In a bribery attack, Alice refuses to pay Ingrid even if Ingrid shows the correct pre-image. Alice achieved so by bribing the miners such that they ignore Ingrid's transaction and leave it unpacked till timeout. The fund lose of Ingrid incentivizes the miners and Alice to collude and gain. This attack breaks the atomicity principle of the payment channel network.

The idea of such a bribery attack is originated from [this EuroS&PW19 paper](https://ieeexplore.ieee.org/document/8802377) on temporary censorship attacks by Winzer et al.. The authors presented three types of briberies on smart contracts. The bribery per miner strategy is the most expensive one with a quadratic collateral to the number of participants, it requires to pay all the miners a fixed amount of money. Pay per block is less costly but there is a risk that the other miners who are not paid choose not to cooperate. Pay-per-commit ignores the honest transaction through a public commit by a high-mining power miner to a malicious mining strategy. Such a bribery to miners is studied in HTLC by Tsabery et al. in the SP21 paper [MAD-HTLC](https://ieeexplore.ieee.org/document/9519476). It considered the incentives of the miners to act in an evil strategy, and provided a game-theoretical analysis of the participants with sub-game perfect equilibrium. An improved HTLC protocol MAD-HTLC is proposed to punish the briber, which gives the confiscate coins to the miner if the sender intends to bribe. A similar idea was proposed in a concurrent paper by Nadahalli et al. at FC21 with a [timelocked bribing](https://link.springer.com/chapter/10.1007/978-3-662-64322-8_3). [HE-HTLC](https://www.ndss-symposium.org/wp-content/uploads/2023/02/ndss2023_f775_paper.pdf), proposed by Wadhwa et al., further extended the bribery attacks in MAD-HTLC by considering a reversed bribery, meaning that the miners bribes Alice for her to trust and collude. Then at FC22, the incentives for the bribery attacks in MAD-HTLC are generalized in [Suborn](https://link.springer.com/chapter/10.1007/978-3-031-18283-9_24) by Avarikioti et al., the aim is to adjust the transaction fees to disincentivize bribes.

### **DoS Attack**

Similar to bribery, an attacker can ignore or exclude an honest transaction by disabling the network with DoS or congestion attacks. For instance, in the [flood&loot](https://dl.acm.org/doi/10.1145/3419614.3423248) attack presented by Harris et al. at AFT20, an attacker floods the payment channel network by starting many small transactions all at once, such that the system doesn't have enough power to take care of the honest transactions before timeout. Such an attack is dangerous for lightning network, because the attack gets a loot by disabling merely 85 channels. [Congestion attack](https://dl.acm.org/doi/10.1007/978-3-662-64331-0_9) proposed by Mizrahi et al. at FC21 takes advantage of the Max HTLC limit in the protocol, sending transactions to the attacker itself, to block the channels with high liquidity.

### **Atomicity**

Another often mentioned HTLC vulnerability is the partial atomicity problem, which leads to the [wormhole attack](https://www.ndss-symposium.org/wp-content/uploads/2019/02/ndss2019_09-4_Malavolta_paper.pdf) presented at NDSS19 by Malavolta et al.. Although HTLC maintains the atomicity in one-hop transactions, a malicious attacker can take advantage of the multi-hop transaction by participating in two or more nodes in the multi-hop path. Then, once the pre-image is known to the attacker, all the nodes between attacker's nodes are skipped and they lose coins to the attacker.

### **Multi-Hop Multi-Party HTLCs**

Improved HTLC schemes have been proposed to overcome the vulnerabilities of HTLC and to provide advanced properties. For instance, at the conference CCS17 by Malavolta et al., [concurrency and privacy](https://dl.acm.org/doi/10.1145/3133956.3134096) are formalized in the universal composability framework and two protocols were design to achieve the properties. In addition, they presented an improved *multi-hop HTLC contract*, which protects the privacy of the players in a payment path with multiple intermediaries. For each player, he or she only knows who is directly talking to in the path, but has no idea about the identity of the sender and receiver in the payment. In atomic cross-chain swap exchanges, players from different blockchains trade their tokens in a fair and trustless way. Narayanam et al. constructed an HTLC contract for multi-party cross-chain exchange at AFT22. What I find interesting is that such an HTLC contract allows multiple players to own and trade assets jointly with the help of MPC. It is called [MP-HTLC](https://arxiv.org/abs/2202.12855).

## Security and Privacy Topics in PCN

In this section, we will focus on the vulnerabilities of current PCN protocols in security and privacy. Being a communication network, PCN protocols suffer from typical attacks on network topology. In addition, the economics incentives in PCN play a significant role in the participants of the protocol.

### **Privacy Attacks**

In FC21, [Kappos et al.](https://dl.acm.org/doi/abs/10.1007/978-3-662-64322-8_8) defined four types of privacy notions in payment channel networks.

- *Private channels*. When two users share a channel, other participants in the network have no idea about the existence of the channel and identity information.
- *Third-party secrecy*. The balance of the channel is kept secret from any third party.
- *On-path relationship anonymity*. For a honest but curious participant on a payment path, the payment relationship should be anonymous. In lightning network, this might be a vulnerable problem because of its centrality.
- *Off-path payment privacy*. Nodes outside the payment path should know nothing about the payment value.

The attacks on privacy we discuss here are mostly on the second and third properties. There is a [timing attack](https://dl.acm.org/doi/10.1145/3419614.3423262) by Rohrer et al. at AFT20 for finding the sender and receiver in a payment path by exploring the related transaction amounts in the payment path and the decreasing deadline in the time locks of the HTLC. Channel balance is also a frequent attacking target. Revealing the balance might lead to unfair fees and malicious attacks on the network. For instance, a [lockdown attack](https://dl.acm.org/doi/abs/10.1007/978-3-030-51280-4_14) by P√©rez-Sol√† at FC20 showed that, using a DoS attack, it is possible to freeze the balances in many channels, so that the critical nodes in the network are blocked thus paralyzes the PCN. Later, a [probing attack](https://link.springer.com/chapter/10.1007/978-3-031-18283-9_16) is proposed by Biryukov et al. at FC22, the authors show geometric strategies to optimize the success probability and attack speed in probing the balance in the channels. A probing attacker sends invalid transactions or transactions to another address owned by the attacker, to find out if the balance of a channel player is larger or smaller than the probing value. This strategy is more efficient than a default binary search. Also, it works when there are multiple channels between the attacker and the probed node.

Due to the privacy concerns, the network topology is unknown in the lightning network and many other PCN networks, which raises new challenges like routing issues in the next subsection. The question studied in Sigmetric20 paper by [Tang et al.](https://dl.acm.org/doi/10.1145/3393691.3394213) answers whether it is possible to achieve a tradeoff between privacy and utility/efficiency.

### **Routing Issue**

When Alice sends Bob coins through the network, she prefers a path that every channel in the path contains enough balance for the transfer and the total transaction fee of the path is as small as possible. This task is difficult because of the unknown network topology, potential depleted channels, and constantly changing channel balances. A simple strategy is to try many channels and detect one that happens to work.

An early routing algorithm as used in [SlientWhispers](https://www.ndss-symposium.org/ndss2017/ndss-2017-programme/silentwhispers-enforcing-security-and-privacy-decentralized-credit-networks/) by Malavolta et al. at NDSS17 and [SpeedyMurmurs](https://www.ndss-symposium.org/wp-content/uploads/2018/02/ndss2018_09-3_Roos_paper.pdf) by Roos et al. at NDSS18 are based on landmarks. The idea of a landmark routing protocol is to calculate a path between sender and receiver through an intermediary node called a landmark. In more detail, landmarks are selected nodes which are well known to every other node in the network. [FSTR](https://ieeexplore.ieee.org/document/9153423) routing proposed at DSN20 by Lin et al. is based on the fund skewness properties, which considers the imbalance in the channels. This is at the cost of privacy.

To reduce the unsuccessful probability of transaction in a routing procedure, it is possible to split the transaction value to smaller portions and transfer them through multiple paths, so that the balances in the paths are more likely to match the transaction. [Spider](https://www.usenix.org/conference/nsdi20/presentation/sivaraman) by Sivaraman et al. at NSDI20 presented a multi-path routing protocol to packetizes the transactions. Later on, in [Boomerang](https://fc20.ifca.ai/preproceedings/12.pdf) designed by Bagaria et al. at FC20 and [Spear](https://dl.acm.org/doi/10.1145/3479722.3480997) by Rahimpour et al. at FC21, a redundant payment path strategy is studied. To show the idea with an example, say, instead of sending 4 coins through 4 channels each with one coin, the sender sends 8 coins through 8 channels each with one coin, and the protocol terminates when 4 out of 8 coins are received. It is ensured by verifiable secret sharing that the remaining 4 coins won't be stolen in the channels. Spear is an improved scheme on boomerang, it has lower latency and smaller computation because it doesn't use the cryptographic primitives as those in boomerang. Lastly, presented at AFT20 by [Tochner et al.](https://dl.acm.org/doi/abs/10.1145/3419614.3423253), an attacker can strategically influence and explore the pattern that transactions are routed in the network. Through a DoS attack, an attacker is able to hijack some routes like in the [bitcoin hijacking attack](https://ieeexplore.ieee.org/document/7958588) by Apostolaki et al. at S&P17 and forces the payment to go through the routes preferred by the attacker. The gain of the attacker might be the liquidity locked in the network, or transaction fees through attacker's network (even though the fee is higher than others thus not preferable when not attacked).

### **Rebalancing**

In payment channel networks, the initial collaterals in each channel might deplete after a while, because one party pays more to the other. When a channel depletes, a naive solution is to close the channel and reopen a new one on-chain. For instance, Loop on the lightning network achieves such a goal. However, it takes time and money to do so. A better solution is rebalancing, as first proposed in [Revive](https://dl.acm.org/doi/10.1145/3133956.3134033) by Khalil et al. at CCS17. The idea is as follows. When Alice's balance ran out in channel 1, and she has enough balance in channel 2 with another party, she can make a transfer to herself into channel 1 to top-up through channel 2 without going on-chain. Revive has several practical problems, first, a delegate is required to handle the rebalance process, in addition, it requires the cooperation of other participants in the network, lastly, it is difficult to route the rebalancing path in a large network with an unknown topology. What's worse, the rebalanced amount by Revive is bounded by the smallest channel balance in the path.  [Hide&seek](https://fc22.ifca.ai/preproceedings/152.pdf) by Avarikioti1 et al. at FC22 studied a linear programming problem in scheduling the rebalancing amount and direction to achieve minimum cost. [Cycle](https://ieeexplore.ieee.org/document/9833795) by Hong et al. at DSN22 proposed to constantly rebalancing to make sure that channels don't go depletion. To avoid a cyclic path to rebalance, [Shaduf](https://www.ndss-symposium.org/ndss-paper/auto-draft-254/) by Ge et al. at NDSS22 gives a non-cycle rebalancing protocol, it doesn't require the rebalancing path to form a cycle. This process is done by binding two channels together for moving the coins between them, and declare such a binding on-chain.

Of course, there is another question to answer, how much money should the players deposit in the channel at the opening phase? Li et al.  gives a balance planning service at infocom20 called [PnP](https://ieeexplore.ieee.org/document/9155375) to decide the initial balance to put in the channel.

### **Watchtowers**

Lastly, we come back at the solutions to deal with offline users or intermediaries in payment channel networks. If a user doesn't want to keep an eye on the channel all the time, it is recommended to hire a watchtower to detect potential frauds. Watchtower has been designed in the lightning network, but it encounters a lack of incentives for the watchtowers to work properly, because the watchtowers are only paid when they find a fraud, but they don't expect to gain a lot because most of the users are honest. So McCorry presented [Pisa](https://webee.technion.ac.il/people/ittay/aft19/aft19-final21.pdf) at AFT19 proposed to pay watchtowers regularly. A drawback is that this scheme is vulnerable to bribery attack. Also it is not friendly to bitcoin because it relies on smart contracts. The second problem is fixed by Mirzaei et al. at FC21 with [FPPW](https://fc21.ifca.ai/papers/51.pdf) to make the watchtower service compatible with the bitcoin. [Outpost](https://eprint.iacr.org/2019/986.pdf), proposed by Khabbazian et al. at AFT19, is one of the first watchtowers that is lightweight (meaning that the watchtower doesn't need to store too much data) and compatible with bitcoin. [Cerberus](https://fc20.ifca.ai/preproceedings/132.pdf) by Avarikioti et al. at FC20 and [Brick](https://fc21.ifca.ai/papers/168.pdf) by Avarikioti et al. at FC21 are schemes with incentives and penalty on watchtowers to encourage them to work properly. And punish the watchtowers if they play evil. [Fail-safe watchtower](https://dl.acm.org/doi/abs/10.1145/3320269.3384716) by Liu et al. at AsiaCCS20 considers attacks like DoS on the watchtower and improved the scheme to protect the service against such attacks. Lastly, Aumayr et al. at CCS22 presented [sleepy channel](https://dl.acm.org/doi/10.1145/3548606.3559370) for users to go offline without hiring watchtowers.

## Improved PCN Protocols

In the final section of this post, I want to give a quick overview on several improved PCN protocols.

PCN protocols to improve certain properties, such as (global) atomicity, path restriction (for a certain network topology), interoperability(whether smart contracts are required), per party collateral, privacy and so on. Per party collateral is linear in the lightning network, as well as Anonymous Multi-Hop Locks ([AMHL](https://www.ndss-symposium.org/ndss-paper/anonymous-multi-hop-locks-for-blockchain-scalability-and-interoperability/)) by Malavolta et al. at NDSS19. Recent protocols can achieve constant per party collateral, including [Sprites](https://fc19.ifca.ai/preproceedings/185-preproceedings.pdf) by Miller et al. at FC19, Atomic Multi-Channel Updates ([AMCU](https://dl.acm.org/doi/10.1145/3319535.3345666)) by Egger et al. at CCS19, [Blitz](https://www.usenix.org/conference/usenixsecurity21/presentation/aumayr) by Aumayr et al. at Usenix security22, and [Thora](https://dl.acm.org/doi/10.1145/3548606.3560556) by Aumayr et al. at CCS22. Collateral is defined by the payment amount multiplied by the locktime, and it reflects the liquidity of a scheme. Large collaterals make the system vulnerable to griefing attacks, where the attacker's aim is to spoil the network by freezing as much collaterals as possible. Path restriction tells whether a protocol is applicable to other topology like a star shape. I hope to mention that AMCU is vulnerable to channel closure attack as discussed by Jourenko et al. in a scheme called [payment trees](https://dl.acm.org/doi/abs/10.1007/978-3-662-64331-0_10) at FC21 . It worths mentioning that Blitz is without HTLC contracts, which means that it is suitable for blockchains without HTLC. Also, it solves the *staggered collateral problem* in multi-hop HTLCs, which is, the locktime in MP-HTLC is often too long, because you have to leave out enough time for each users to react after one receives the secret.

## About the Author

‚úçüèª Yunwen Liu

Yunwen Liu is a cryptographer at Cryptape. She completed her Ph.D at COSIC, KU Leuven. She published 20+ research papers in venues including Eurocrypt and Journal of Cryptology. She has served on the program committees of Eurocrypt 2022 and ToSC 2022/2023.
